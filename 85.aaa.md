```shell script
node('jenkins-test') {   #在jenkins添加slave pod模板的时候指定的：标签列表，下面所有的工作都会在这个slave节点下进行
    stage('Clone') {  #第一步克隆代码
        echo "1.Clone Stage"
        git url: "http://gitlab.liuxiang.com:13800/liuxiang/prometheus_config.git"
        script {
            build_tag = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim() #生成一个随机数，源码一旦修改，随机数也变化，随机数复制给build_tag
        }
    }
    stage('Test') {
      echo "2.Test Stage"

    }
    stage('Build') {  # 第三部，构建一个docker镜像
        echo "3.Build Docker Image Stage"
        sh "docker build -t 192.168.40.182/jenkins-demo/jenkins-demo:${build_tag} ."  # 写harbor的镜像
    }
    stage('Push') {   # 第四部，上传到harbor仓库
        echo "4.Push Docker Image Stage"
        withCredentials([usernamePassword(credentialsId: 'dockerharbor', passwordVariable: 'dockerHubPassword', usernameVariable: 'dockerHubUser')]) {
            sh "docker login 192.168.40.182 -u ${dockerHubUser} -p ${dockerHubPassword}"
            sh "docker push 192.168.40.182/jenkins-demo/jenkins-demo:${build_tag}"
        }
    }
    stage('Deploy to dev') {  # 第五部，部署到开发环境
        echo "5. Deploy DEV"
		sh "sed -i 's/<BUILD_TAG>/${build_tag}/' k8s-dev-harbor.yaml" # 把k8s-dev-harbor.yaml里面的BUILD_TAG，替换成build_tag
        sh "sed -i 's/<BRANCH_NAME>/${env.BRANCH_NAME}/' k8s-dev-harbor.yaml"
        //sh "bash running-devlopment.sh"
        sh "kubectl apply -f k8s-dev-harbor.yaml  --validate=false"
	}	
	stage('Promote to qa') {	# 项目发不到测试
		def userInput = input(  # 用户交互
            id: 'userInput',
            message: 'Promote to qa?',  #
            parameters: [
                [
                    $class: 'ChoiceParameterDefinition',
                    choices: "YES\nNO", # 选择yes or no
                    name: 'Env'
                ]
            ]
        )
        echo "This is a deploy step to ${userInput}"
        if (userInput == "YES") {   # 如果userInput是YES
            sh "sed -i 's/<BUILD_TAG>/${build_tag}/' k8s-qa-harbor.yaml"
            sh "sed -i 's/<BRANCH_NAME>/${env.BRANCH_NAME}/' k8s-qa-harbor.yaml"
            //sh "bash running-qa.sh"
            sh "kubectl apply -f k8s-qa-harbor.yaml --validate=false"
            sh "sleep 6"
            sh "kubectl get pods -n qatest"
        } else {
            //exit  # 否则userInput是NO，就退出此步骤
        }
    }
	stage('Promote to pro') {	  # 部署到生产
		def userInput = input(
            id: 'userInput',
            message: 'Promote to pro?',
            parameters: [
                [
                    $class: 'ChoiceParameterDefinition',
                    choices: "YES\nNO", # 是否部署到生产
                    name: 'Env'
                ]
            ]
        )
        echo "This is a deploy step to ${userInput}"
        if (userInput == "YES") {
            sh "sed -i 's/<BUILD_TAG>/${build_tag}/' k8s-prod-harbor.yaml"
            sh "sed -i 's/<BRANCH_NAME>/${env.BRANCH_NAME}/' k8s-prod-harbor.yaml"
            //sh "bash running-production.sh"
            sh "cat k8s-prod-harbor.yaml"
            sh "kubectl apply -f k8s-prod-harbor.yaml --record --validate=false"
        }
    }
}

```

### 回滚
#### 回滚前查看
```shell script
[root@jenkins-k8s-master01 jenkins]# kubectl get all -n jenkins-k8s                            
NAME                           READY   STATUS    RESTARTS   AGE
pod/jenkins-77cf549b6b-ttgl2   1/1     Running   0          24h

NAME                      TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE
service/jenkins-service   NodePort   10.108.120.16   <none>        8080:30002/TCP,50000:30099/TCP   24h

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/jenkins   1/1     1            1           24h

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/jenkins-77cf549b6b   1         1         1       24h
```
```shell script
[root@jenkins-k8s-master01 jenkins]# kubectl rollout history deploy/jenkins -n jenkins-k8s 
deployment.apps/jenkins 
REVISION  CHANGE-CAUSE
1         <none>
```
```shell script
node('jenkins-test') { 
    stage('git clone') {
        git url: "https://github.com/luckylucky421/jenkins-rollout" 
        sh "ls -al"
        sh "pwd"
    }
    stage('select env') { # 定义回滚哪个名称空间
        def envInput = input(
            id: 'envInput',
            message: 'Choose a deploy environment', 
            parameters: [
                [
                    $class: 'ChoiceParameterDefinition',
                    choices: "devlopment\nqatest\nproduction", 
                    name: 'Env'
                ] 
            ]
        )
        echo "This is a deploy step to ${envInput}"
        sh "sed -i 's/<namespace>/${envInput}/' getVersion.sh"  # 将名称空间替换到getVersion.sh
        sh "sed -i 's/<namespace>/${envInput}/' rollout.sh"     # 将名称空间替换到rollout.sh
        sh "bash getVersion.sh" # 执行这个脚本，生成一个csv文件，里面记录这版本
        // env.WORKSPACE = pwd()
        // def version = readFile "${env.WORKSPACE}/version.csv" 
        // println version
        }
    stage('select version') { 
        env.WORKSPACE = pwd()
        def version = readFile "${env.WORKSPACE}/version.csv" 
        println version
        def userInput = input(id: 'userInput',
            message: '选择回滚版本',
            parameters: [
                [
                    $class: 'ChoiceParameterDefinition', 
                    choices: "$version\n",
                    name: 'Version'
                ] 
            ]
        ) 
        sh "sed -i 's/<version>/${userInput}/' rollout.sh"
    }
    stage('rollout deploy') {
        sh "bash rollout.sh" 
        }
    }
```

### 获取k8s回滚的使用deployment部署app的版本，放到git上
```shell script
jenkins-rollout/getVersion.sh
vim getVersion.sh
```
```shell script
kubectl rollout history deploy/jenkins-demo -n <namespace> | grep -v "deployment" | grep -v "REVISION" | awk '{print $1}' > version.csv #脚本模板
kubectl rollout history deploy/jenkins -n jenkins-k8s | grep -v "deployment" | grep -v "REVISION" | awk '{print $1}' > version.csv  # 可用模板
```
```shell script
deploy/jenkins-demo : 指定的控制器/控制器下app的名称
-n <namespace> : 指定名称空间 
grep -v "deployment" : 忽略deployment开头的行
grep -v "REVISION" : 忽略REVISION开头的行
awk '{print $1}': 列出版本
> version.csv : 重定向到version.csv这个文件
```
### 回滚
```shell script
jenkins-rollout/rollout.sh
```
```shell script
kubectl rollout undo deployment jenkins-demo  --to-revision=<version> -n <namespace>  # 脚本模板
kubectl rollout undo deployment jenkins  --to-revision=<version> -n jenkins-k8s
```