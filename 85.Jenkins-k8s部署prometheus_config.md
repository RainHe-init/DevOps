### Jenkins做CI/CD，构建prometheus管理配置工具
#### 1、将prometheus配置工具迁移至gitlab，公开项目
```shell script
http://gitlab.liuxiang.com:13800/liuxiang/prometheus_config.git
```
![image](https://github.com/498946975/DevOps/blob/master/images/jenkins17.png)
#### 2、开发部署文件
```shell script
(venv) 192:prometheus_config oliver$ pwd
/Users/oliver/Documents/PyCharm/prometheus_config
(venv) 192:prometheus_config oliver$ ls -l
total 168
.....
-rw-r--r--   1 oliver  staff    729 Oct 27 21:16 deployment.yaml
......
.......
-rw-r--r--   1 oliver  staff    683 Oct 27 21:53 ingress.yaml
.......
```
```yaml
apiVersion: v1
kind: Service
metadata:
  name: prometheusconfig
  namespace: default
spec:
  selector:
    app: prometheusconfig
  ports:
  - name: http
    targetPort: 8000
    port: 8000
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheusconfig
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheusconfig
  template:
    metadata:
      labels:
        app: prometheusconfig
    spec:
      containers:
      - name: prometheusconfig
        image: prometheus_config:v7.0
        imagePullPolicy: IfNotPresent
        command: ["/bin/bash"]
        args: ["-c", "python3 manage.py runserver 0.0.0.0:8000"]
        ports:
        - name: http
          containerPort: 8000
```
```yaml
apiVersion: extensions/v1beta1 #api 版本
kind: Ingress #清单类型
metadata: #元数据
  name: ingress-myapp
  namespace: default  #ingress 的名称 #所属名称空间
  annotations:  #注解信息
    kubernetes.io/ingress.class: "nginx"
spec: #规格
  rules: #定义后端转发的规则
  - host: prometheusconfig.liuxiang.com #通过域名进行转发
    http:
      paths:
      - path: #配置访问路径，如果通过 url 进行转发，需要修改:空默认为访问的路径为"/"
        backend: #配置后端服务
          serviceName: prometheusconfig #匹配上面创建的svc的名称
          servicePort: 8000 #匹配上面创建的svc暴露的端口
```
#### 3、将harobr的账号密码，写入jenkins凭据
![image](https://github.com/498946975/DevOps/blob/master/images/jenkins18.png)
#### 4、在构建好的Jenkins上，新增流水线，prometheus_config
```shell script
node('jenkins-test') {
    stage('Change hosts') {
        echo "1.Change hosts files"
        sh 'echo "172.16.120.55 gitlab.liuxiang.com" >> /etc/hosts'
        sh 'echo "172.16.120.202 harbor.liuxiang.com" >> /etc/hosts'
    }
    stage('Clone') {
        echo "2.Clone Stage"
        git branch: 'produce', url: 'http://gitlab.liuxiang.com:13800/liuxiang/prometheus_config.git'
        script {
            build_tag = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
        }
    }
    stage('Build') {
        echo "3.Build Docker Image Stage"
        sh "docker build -t harbor.liuxiang.com/prometheus_config/prometheus_config:${build_tag} ."
    }
    stage('Push') {
        echo "4.Push Docker Image Stage"
        withCredentials([usernamePassword(credentialsId: 'docker_harbor', passwordVariable: 'dockerHubPassword', usernameVariable: 'dockerHubUser')]) {
            sh "docker login harbor.liuxiang.com -u ${dockerHubUser} -p ${dockerHubPassword}"
            sh "docker push harbor.liuxiang.com/prometheus_config/prometheus_config:${build_tag}"
        }
    }
}

```