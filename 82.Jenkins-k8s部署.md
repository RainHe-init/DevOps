### k8s下安装Jenkins的前提
#### 1、在master和node上都安装nfs服务
```shell script
yum install nfs-utils -y
systemctl start nfs
systemctl enable nfs
```
#### 2、在master上，创建nfs共享目录
```shell script
[root@jenkins-k8s-master01 ~]# mkdir /data/v2 -p
[root@jenkins-k8s-master01 ~]# echo "/data/v2 172.16.120.0/24(rw,no_root_squash)" >> /etc/exports
[root@jenkins-k8s-master01 ~]# exportfs -arv
[root@jenkins-k8s-master01 ~]# systemctl restart nfs
```
#### 3、创建名称空间
```shell script
[root@jenkins-k8s-master01 ~]# kubectl create namespace jenkins-k8s
namespace/jenkins-k8s created
```
#### 4、创建pv
```shell script
[root@jenkins-k8s-master01 ~]# cd jenkins/
[root@jenkins-k8s-master01 jenkins]# vim pv.yaml
```
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: jenkins-k8s-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteMany
  nfs:
    server: 172.16.120.121
    path: /data/v2
```
```shell script
[root@jenkins-k8s-master01 jenkins]# kubectl apply -f pv.yaml 
persistentvolume/jenkins-k8s-pv created
[root@jenkins-k8s-master01 jenkins]# kubectl get pv -A
NAME             CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
jenkins-k8s-pv   10Gi       RWX            Retain           Available                                   5s
```
#### 5、创建pvc
```shell script
[root@jenkins-k8s-master01 jenkins]# vim pvc.yaml
```
```yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: jenkins-k8s-pvc
  namespace: jenkins-k8s
spec:
  resources:
    requests:
      storage: 10Gi
  accessModes:
  - ReadWriteMany
```
```shell script
[root@jenkins-k8s-master01 jenkins]# kubectl  apply -f pvc.yaml 
persistentvolumeclaim/jenkins-k8s-pvc created
[root@jenkins-k8s-master01 jenkins]# kubectl get pvc -A
NAMESPACE     NAME              STATUS   VOLUME           CAPACITY   ACCESS MODES   STORAGECLASS   AGE
jenkins-k8s   jenkins-k8s-pvc   Bound    jenkins-k8s-pv   10Gi       RWX                           5s
```
#### 6、创建sa账号，并使用rbac授权
```shell script
[root@jenkins-k8s-master01 jenkins]# kubectl create sa jenkins-k8s-sa -n jenkins-k8s
serviceaccount/jenkins-k8s-sa created
[root@jenkins-k8s-master01 jenkins]# kubectl create clusterrolebinding jenkins-k8s-sa-cluster -n jenkins-k8s --clusterrole=cluster-admin --serviceaccount=jenkins-k8s:jenkins-k8s-sa
clusterrolebinding.rbac.authorization.k8s.io/jenkins-k8s-sa-cluster created
```
#### 7、使用deployment创建jenkins
```shell script
[root@jenkins-k8s-master01 jenkins]# vim jenkins-deployment.yaml 
```
```yaml
kind: Deployment
apiVersion: apps/v1
metadata:
  name: jenkins
  namespace: jenkins-k8s
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jenkins
  template:
    metadata:
      labels:
        app: jenkins
    spec:
      serviceAccount: jenkins-k8s-sa
      containers:
      - name: jenkins
        image:  jenkins/jenkins:lts
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: web
          protocol: TCP
        - containerPort: 50000
          name: agent
          protocol: TCP
        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /login
            port: 8080
          initialDelaySeconds: 60
          timeoutSeconds: 5
          failureThreshold: 12
        readinessProbe:
          httpGet:
            path: /login
            port: 8080
          initialDelaySeconds: 60
          timeoutSeconds: 5
          failureThreshold: 12
        volumeMounts:
        - name: jenkins-volume
          subPath: jenkins-home
          mountPath: /var/jenkins_home
      volumes:
      - name: jenkins-volume
        persistentVolumeClaim:
          claimName: jenkins-k8s-pvc
```